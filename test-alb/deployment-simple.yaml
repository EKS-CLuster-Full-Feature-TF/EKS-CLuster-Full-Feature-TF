# Simple deployment using a basic web server
# This uses a shell script to serve pod information
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-app
  namespace: default
  labels:
    app: test-app
spec:
  replicas: 2
  selector:
    matchLabels:
      app: test-app
  template:
    metadata:
      labels:
        app: test-app
    spec:
      containers:
      - name: web
        image: busybox:latest
        command:
        - /bin/sh
        - -c
        - |
          echo "Starting web server..."
          while true; do
            echo -e "HTTP/1.1 200 OK\r\nContent-Type: text/html\r\n\r\n" > /tmp/response
            cat >> /tmp/response <<EOF
          <!DOCTYPE html>
          <html>
          <head><title>EKS ALB Test</title></head>
          <body style="font-family: Arial; padding: 20px; background: #f0f0f0;">
            <h1>ðŸš€ EKS ALB Test Application</h1>
            <div style="background: white; padding: 20px; border-radius: 5px; margin: 10px 0;">
              <p><strong>Pod Name:</strong> $POD_NAME</p>
              <p><strong>Namespace:</strong> $POD_NAMESPACE</p>
              <p><strong>Pod IP:</strong> $POD_IP</p>
              <p><strong>Node:</strong> $NODE_NAME</p>
              <p><strong>Time:</strong> $(date)</p>
            </div>
            <p style="color: #666;">Refresh to see load balancing across pods!</p>
          </body>
          </html>
          EOF
            nc -l -p 80 -e cat /tmp/response
          done
        ports:
        - containerPort: 80
          name: http
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName

